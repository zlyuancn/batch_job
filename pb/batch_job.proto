syntax = 'proto3';
package batch_job; // 决定proto引用路径和rpc路由
option go_package = "github.com/zlyuancn/batch_job/pb"; // 用于对golang包管理的定位

import "google/api/annotations.proto";  // 添加导入
import "validate/validate.proto";

// 批量任务服务
service BatchJobService{
  // 业务注册
  rpc AdminRegistryBiz(AdminRegistryBizReq) returns (AdminRegistryBizRsp) {
    option (google.api.http) = {
      post: "/BatchJob/AdminRegistryBiz",
      body: "*",
    };
  }
  // 修改业务
  rpc AdminChangeBiz(AdminRegistryBizReq) returns (AdminRegistryBizRsp){
    option (google.api.http) = {
      post: "/BatchJob/AdminChangeBiz",
      body: "*",
    };
  }
  // 创建任务
  rpc AdminCreateJob(AdminCreateJobReq) returns (AdminCreateJobRsp) {
    option (google.api.http) = {
      post: "/BatchJob/AdminCreateJob",
      body: "*",
    };
  }
  // 启动任务
  rpc AdminStartJob(AdminStartJobReq) returns (AdminStartJobRsp) {
    option (google.api.http) = {
      post: "/BatchJob/AdminStartJob",
      body: "*",
    };
  }
  // 停止任务
  rpc AdminStopJob(AdminStopJobReq) returns (AdminStopJobRsp) {
    option (google.api.http) = {
      post: "/BatchJob/AdminStopJob",
      body: "*",
    };
  }


  // 查询业务信息
  rpc QueryBizInfo(QueryBizInfoReq) returns (QueryBizInfoRsp) {
    option (google.api.http) = {
      post: "/BatchJob/QueryBizInfo",
      body: "*",
    };
  }
  // 查询业务列表
  rpc QueryBizList(QueryBizListReq) returns (QueryBizListRsp) {
    option (google.api.http) = {
      post: "/BatchJob/QueryBizList",
      body: "*",
    };
  }
  // 查询任务基本信息
  rpc QueryJobBaseInfo(QueryJobBaseInfoReq) returns (QueryJobBaseInfoRsp) {
    option (google.api.http) = {
      post: "/BatchJob/QueryJobBaseInfo",
      body: "*",
    };
  }
  // 查询任务列表
  rpc QueryJobList(QueryJobListReq) returns (QueryJobListRsp) {
    option (google.api.http) = {
      post: "/BatchJob/QueryJobList",
      body: "*",
    };
  }
  // 查询任务的数据日志
  rpc QueryJobDataLog(QueryJobDataLogReq) returns (QueryJobDataLogRsp) {
    option (google.api.http) = {
      post: "/BatchJob/QueryJobDataLog",
      body: "*",
    };
  }

  // 业务启动. 要求任务必须处于 JobStatus.WaitBizRun 状态
  rpc BizStartJob(BizStartJobReq) returns (BizStartJobRsp) {
    option (google.api.http) = {
      post: "/BatchJob/BizStartJob",
      body: "*",
    };
  }
  // 要求业务停止运行. 一般为业务判断任务无法继续的时候
  rpc BizStopJob(BizStopJobReq) returns (BizStopJobRsp) {
    option (google.api.http) = {
      post: "/BatchJob/BizStopJob",
      body: "*",
    };
  }
  // 更新业务数据. 要求任务必须处于 JobStatus.WaitBizRun 状态或者串行化速率类型的任务可以使用
  rpc BizUpdateBizData(BizUpdateBizDataReq) returns (BizUpdateBizDataRsp) {
    option (google.api.http) = {
      post: "/BatchJob/BizUpdateBizData",
      body: "*",
    };
  }
  // 增加已处理数
  rpc BizIncrProcessedNum(BizIncrProcessedNumReq) returns (BizIncrProcessedNumRsp) {
    option (google.api.http) = {
      post: "/BatchJob/BizIncrProcessedNum",
      body: "*",
    };
  }
  // 增加数据日志
  rpc BizAddDataLog(BizAddDataLogReq) returns (BizAddDataLogRsp) {
    option (google.api.http) = {
      post: "/BatchJob/BizAddDataLog",
      body: "*",
    };
  }

}

// 速率类型
enum RateType {
  RateType_RateSec = 0; // 标准限速
  RateType_Serialization = 1; // 串行化限速
}

// 执行类型
enum ExecType {
  ExecType_None = 0;
  ExecType_HttpCallback = 1; // http回调
}

// 业务状态
enum BizStatus {
  BizStatus_None = 0; // 正常
  BizStatus_Hidden = 1; // 隐藏
}

message AdminRegistryBizReq {
  int32 bizType = 1 [(validate.rules).int32.gt = 0]; // 业务类型. 必填
  string bizName = 2 [(validate.rules).string.min_len = 1]; // 业务名
  string remark = 3; // 备注

  ExecType execType = 4; // 执行类型
  string cbBeforeCreate = 5 [(validate.rules).string = {uri: true, ignore_empty: true}]; // 创建任务回调url
  string cbBeforeRun = 6 [(validate.rules).string = {uri: true, ignore_empty: true}]; // 启动前回调. 一旦配置, 则任务必须由业务主动调用 BizStartJob 执行任务. 否则任务将一直处于 JobStatus.WaitBizRun 状态
  string cbProcess = 7 [(validate.rules).string = {uri: true}]; // 处理任务回调. 必填
  string cbProcessStop = 8 [(validate.rules).string = {uri: true, ignore_empty: true}]; // 任务停止回调. 用于业务方做一些清理. 选填
  int32 cbBeforeCreateTimeout = 9 [(validate.rules).int32.gte = 0]; // 启动前回调超时秒数
  int32 cbBeforeRunTimeout = 10 [(validate.rules).int32.gte = 0]; // 启动前回调超时秒数
  int32 cbProcessTimeout = 11 [(validate.rules).int32.gte = 0]; // 处理任务回调超时秒数
  int32 cbProcessStopTimeout = 12 [(validate.rules).int32.gte = 0]; // 处理任务停止回调超时秒数

  RateType rateType = 13; // 速率类型
  int32 rateSec = 14; // 每秒处理速率. 0表示不限制

  OpInfoQ op = 15; // 操作信息
  BizStatus status = 16; // 状态 0=正常 1=隐藏
}
message AdminRegistryBizRsp {}

// 操作信息-请求
message OpInfoQ {
  string opSource = 1; // 操作来源
  string opUserid = 2; // 操作用户id
  string opUserName = 3; // 操作用户名
  string opRemark = 4; // 操作备注
}

// 操作信息-响应
message OpInfoA {
  string opSource = 1; // 操作来源
  string opUserid = 2; // 操作用户id
  string opUserName = 3; // 操作用户名
  string opRemark = 4; // 操作描述
  int64 opTime = 5; // 操作秒级时间戳
}

// 业务操作历史-响应
message BizOpHistoryA {
  OpInfoA op = 1; // 操作信息
  BizInfoA info = 2; // 相关数据
}

// 任务状态
enum JobStatus {
  Created = 0; // 已创建
  WaitBizRun = 1; // 等待业务主动启动
  Running = 2; // 运行中
  Finished = 3; // 已完成
  Stopping = 4; // 正在停止
  Stopped = 5; // 已停止
}

// 业务信息-响应
message BizInfoA {
  int32 bizType = 1; // 业务类型. 必填
  string bizName = 2; // 业务名
  string remark = 3; // 备注
  ExecType execType = 4; // 执行类型
  string cbBeforeCreate = 5; // 创建任务回调url
  string cbBeforeRun = 6; // 启动前回调. 一旦配置, 则任务必须由业务主动调用 BizStartJob 执行任务. 否则任务将一直处于 JobStatus.WaitBizRun 状态
  string cbProcess = 7; // 处理任务回调
  string cbProcessStop = 8; // 处理任务停止回调. 用于业务方做一些清理
  int32 cbBeforeCreateTimeout = 9; // 启动前回调超时秒数
  int32 cbBeforeRunTimeout = 10; // 启动前回调超时秒数
  int32 cbProcessTimeout = 11; // 处理任务回调超时秒数
  int32 cbProcessStopTimeout = 12; // 处理任务停止回调超时秒数
  RateType rateType = 13; // 速率类型
  int32 rateSec = 14; // 每秒处理速率. 0表示不限制
  OpInfoA op = 15; // 操作信息
  BizStatus status = 16; // 状态 0=正常 1=隐藏
}

// 任务基础信息-响应
message JobBaseInfoA {
  int64 jobId = 1; // 任务id
  int32 bizType = 2; // 业务类型
  string bizData = 3; // 业务任务数据, 让业务知道应该做什么
  int64 processDataTotal = 4; // 业务中需要处理数据总数
  int64 processedNum = 5; // 已处理过的数据量, 无论成功还是失败
  int64 errLogNum = 6; // 错误日志数
  JobStatus status = 7; // 任务状态
  int64 createTime = 8; // 创建时间秒级时间戳
  OpInfoA op = 9; // 操作信息
  string statusInfo = 10; // 状态信息
}

// 数据的日志类型
enum DataLogType {
  Debug = 0; // 调试
  Info = 1; // 信息
  Warn = 2; // 警告
  Err = 3; // 错误
}

// 日志-请求
message DataLogQ {
  string dataId = 1; // 数据id
  string remark = 2; // 备注
  string extend = 3; // 扩展数据
  DataLogType logType = 4; // 日志类型
}

// 日志-响应
message DataLogA {
  string dataId = 1; // 数据id
  string remark = 2; // 备注
  string extend = 3; // 扩展数据
  DataLogType logType = 4; // 日志类型
  int64 createTime = 5; // 创建时间秒级时间戳
}

message AdminCreateJobReq {
  int32 bizType = 1 [(validate.rules).int32.gt = 0]; // 业务类型. 必填
  string bizData = 2; // 业务任务数据, 让业务知道应该做什么
  string bizProcessData = 3; // 业务中需要处理的批量数据
  int64 processDataTotal = 4; // 需要处理数据总数
  bool startNow = 5; // 创建后是否立即启动
  OpInfoQ op = 6; // 操作信息
}
message AdminCreateJobRsp {
  int64 jobId = 1; // 创建的任务id
}

message AdminStartJobReq {
  int64 jobId = 1 [(validate.rules).int64.gt = 0]; // 创建的任务id. 必填
  OpInfoQ op = 2; // 操作信息
}
message AdminStartJobRsp {}

message AdminStopJobReq {
  int64 jobId = 1 [(validate.rules).int64.gt = 0]; // 创建的任务id. 必填
  OpInfoQ op = 2; // 操作信息
}
message AdminStopJobRsp {}

message QueryBizInfoReq {
  int32 bizType = 1 [(validate.rules).int32.gt = 0]; // 创建的业务类型. 必填
}
message QueryBizInfoRsp {
  BizInfoA line = 1; // 业务信息
}

message QueryBizListReq {
  int32 page = 1 [(validate.rules).int32.gt = 0]; // 页号, 从1开始
  int32 pageSize = 2 [(validate.rules).int32.gte = 5]; // 每页返回数量, 最少返回5条
  string opUser = 3; // 操作人
  BizStatus status = 4; // 状态 0=正常 1=隐藏
}
message QueryBizListRsp {
  int32 total = 1; // 总条数
  int32 pageSize = 2; // 当前分一页预期返回条数
  repeated BizInfoA line = 3; // 业务信息
}

message QueryJobBaseInfoReq {
  int64 jobId = 1 [(validate.rules).int64.gt = 0]; // 创建的任务id. 必填
}
message QueryJobBaseInfoRsp {
  JobBaseInfoA baseInfo = 1; // 任务基础信息
}

message QueryJobListReq {
  int64 startTime = 1; // 开始时间, 秒级时间戳. 0表示不限制
  int64 endTime = 2; // 结束时间, 秒级时间戳. 0表示不限制
  string opUser = 3; // 操作人
  repeated int32 bizType = 4 [(validate.rules).repeated = {
    unique: true, // 内部数据不允许重复
    ignore_empty: true, // 允许空数据
    items : {
      int32 : {
        gt: 0,
      }
    }
  }]; // 业务类型
  int32 page = 5 [(validate.rules).int32.gt = 0]; // 页号, 从1开始
  int32 pageSize = 6 [(validate.rules).int32.gte = 5]; // 每页返回数量, 最少返回5条
}
message QueryJobListRsp {
  int32 total = 1; // 总条数
  int32 pageSize = 2; // 当前分一页预期返回条数
  repeated JobBaseInfoA line = 3; // 基础任务信息
}

message QueryJobDataLogReq {
  int64 jobId = 1 [(validate.rules).int64.gt = 0]; // 创建的任务id. 必填
  int32 page = 2 [(validate.rules).int32.gt = 0]; // 页号, 从1开始
  int32 pageSize = 3 [(validate.rules).int32.gte = 5]; // 每页返回数量, 最少返回5条
  DataLogType logType = 4; // 日志类型
}
message QueryJobDataLogRsp {
  int32 total = 1; // 总条数
  int32 pageSize = 2; // 当前分一页预期返回条数
  repeated DataLogA log = 3; // 日志
}

message BizStartJobReq {
  int64 jobId = 1 [(validate.rules).int64.gt = 0]; // 创建的任务id. 必填
}
message BizStartJobRsp {}

message BizStopJobReq {
  int64 jobId = 1 [(validate.rules).int64.gt = 0]; // 创建的任务id. 必填
}
message BizStopJobRsp {}

message BizUpdateBizDataReq {
  int64 jobId = 1 [(validate.rules).int64.gt = 0]; // 创建的任务id. 必填
  string bizData = 2; // 业务任务数据, 让业务知道应该做什么. 空值则不会更新这个数据
  string bizProcessData = 3; // 业务中需要处理的批量数据. 空值则不会更新这个数据
  int64 processDataTotal = 4; // 需要处理数据总数. 空值则不会更新这个数据
  int64 processedNum = 5; // 已处理过的数据量, 无论成功还是失败. 空值则不会更新这个数据
}
message BizUpdateBizDataRsp {}

message BizIncrProcessedNumReq {
  int64 jobId = 1 [(validate.rules).int64.gt = 0]; // 创建的任务id. 必填
  int64 num = 2 [(validate.rules).int64.gt = 0]; // 增加数量. 必填
}
message BizIncrProcessedNumRsp {}

message BizAddDataLogReq {
  int64 jobId = 1 [(validate.rules).int64.gt = 0]; // 创建的任务id. 必填
  repeated DataLogQ log = 2; // 日志内容
}
message BizAddDataLogRsp {}
